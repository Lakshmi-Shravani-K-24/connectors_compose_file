const fs = require('fs');

function calculateSeverityCounts(data) {
    const trivyOutput = JSON.parse(data);
    const severityCounts = {
        UNKNOWN: 0,
        LOW: 0,
        MEDIUM: 0,
        HIGH: 0,
        CRITICAL: 0
    };

    trivyOutput.Results.forEach(result => {
        if (result.Vulnerabilities) {
            result.Vulnerabilities.forEach(vulnerability => {
                const severity = vulnerability.Severity.toUpperCase();
                severityCounts[severity] = (severityCounts[severity] || 0) + 1;
            });
        }
    });

    return severityCounts;
}

function compareWithStandardCounts(fileData, standardCounts) {
    const severityCounts = calculateSeverityCounts(fileData);

    for (const severity in severityCounts) {
        if (severityCounts[severity] > standardCounts[severity]) {
            console.log(`File 1 has higher vulnerability count than standard for ${severity}:`);
            console.log(`File 1: ${severityCounts[severity]}, Standard: ${standardCounts[severity]}`);
        } else if (severityCounts[severity] < standardCounts[severity]) {
            console.log(`File 1 has lower vulnerability count than standard for ${severity}:`);
            console.log(`File 1: ${severityCounts[severity]}, Standard: ${standardCounts[severity]}`);
        } else {
            console.log(`File 1 has the same vulnerability count as standard for ${severity}: ${severityCounts[severity]}`);
        }
    }
}

// Reading the contents of the JSON file 1
fs.readFile('./trivy_output_1.json', 'utf8', (err, data) => {
    if (err) {
        console.error('Error reading JSON file:', err);
        return;
    }

    // Reading the standard counts from the standard file
    fs.readFile('./standard_vulnerability_counts.json', 'utf8', (err, standardData) => {
        if (err) {
            console.error('Error reading standard counts file:', err);
            return;
        }

        try {
            const standardCounts = JSON.parse(standardData);
            compareWithStandardCounts(data, standardCounts);
        } catch (error) {
            console.error('Error comparing JSON files:', error);
        }
    });
});
